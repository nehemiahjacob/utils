#!/bin/bash

# File ID: b8c0ee54-eb71-11df-a07a-fefdb24f8e10

remotes=origin
test -z "$1" || remotes="$@"
test "$remotes" = "-a" && { remotes=$(git remote); shift; }
origbranch=$(git branch | grep ^\\* | cut -c 3-)
git checkout $(git log -1 --format=%H)
echo
for remote in $remotes; do
    echo ==== remote $remote
    for f in $(git branch -a | grep remotes/$remote/ | grep -v "remotes/$remote/HEAD " | perl -pe "s!remotes/$remote/(.*)\$!\$1!"); do
        git branch -t $f $remote/$f 2>&1 | grep -v '^fatal: A branch named .* already exists.'
        git push . $remote/$f:$f 2>&1 | grep -v '^Everything up-to-date'
    done
    echo
done
git checkout $origbranch
